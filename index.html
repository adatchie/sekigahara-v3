<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Sekigahara RTS - Balance Patch</title>

    <!-- Three.js Library -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            color: #eee;
            user-select: none;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .hud-panel {
            position: absolute;
            background: rgba(20, 20, 30, 0.85);
            border: 1px solid #888;
            padding: 10px;
            border-radius: 2px;
            pointer-events: auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #top-bar {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 2px 2px 4px black;
            letter-spacing: 2px;
        }

        #action-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            font-size: 22px;
            padding: 15px 50px;
            background: #8b0000;
            color: white;
            border: 1px solid #ff4500;
            cursor: pointer;
            pointer-events: auto;
            font-family: serif;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: 0.2s;
        }

        #action-btn:hover {
            background: #a00000;
            letter-spacing: 2px;
        }

        #action-btn:active {
            transform: translateY(2px);
        }

        #context-menu {
            position: absolute;
            display: none;
            flex-direction: column;
            gap: 1px;
            background: #fff;
            padding: 2px;
            border: 1px solid #000;
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            z-index: 100;
        }

        .ctx-btn {
            padding: 10px 25px;
            font-size: 15px;
            cursor: pointer;
            border: none;
            background: #f0f0f0;
            color: #000;
            font-family: serif;
            transition: 0.1s;
        }

        .ctx-btn:hover {
            background: #ddd;
            padding-left: 30px;
        }

        #unit-list {
            position: absolute;
            top: 70px;
            left: 20px;
            width: 280px;
            max-height: 70vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: none;
        }

        #unit-list::-webkit-scrollbar {
            width: 5px;
        }

        #unit-list::-webkit-scrollbar-thumb {
            background: #555;
        }

        .unit-card {
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.6));
            border-left: 4px solid #555;
            padding: 8px;
            font-size: 13px;
            color: #ddd;
            display: flex;
            gap: 12px;
            align-items: center;
            pointer-events: auto;
            transition: 0.2s;
        }

        .unit-card:hover {
            transform: translateX(5px);
            background: rgba(50, 50, 50, 0.9);
        }

        .card-east {
            border-color: #88AAEE;
        }

        .card-west {
            border-color: #EE4444;
        }

        .portrait {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #aaa;
            background: #222;
            display: block;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
        }

        .formation-toggle {
            margin-top: 4px;
            padding: 4px 8px;
            font-size: 11px;
            background: #333;
            border: 1px solid #666;
            color: #ffd700;
            cursor: pointer;
            transition: 0.2s;
            font-family: serif;
        }

        .formation-toggle:hover {
            background: #444;
            border-color: #ffd700;
        }

        .formation-selector {
            display: none;
            margin-top: 4px;
            gap: 3px;
            flex-direction: column;
            padding: 4px 0;
        }

        .formation-selector.show {
            display: flex;
        }

        .formation-select-btn {
            padding: 4px 8px;
            font-size: 10px;
            background: #2a2a2a;
            border: 1px solid #555;
            color: #ddd;
            cursor: pointer;
            transition: 0.15s;
            font-family: serif;
        }

        .formation-select-btn:hover:not(.disabled) {
            background: #3a3a3a;
            border-color: #ffd700;
        }

        .formation-select-btn.active {
            background: #554400;
            border-color: #ffd700;
            color: #ffd700;
        }

        .formation-select-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }


        #effect-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            overflow: hidden;
        }

        #flash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            opacity: 0;
            pointer-events: none;
            z-index: 90;
            transition: opacity 0.5s;
            mix-blend-mode: overlay;
        }

        #victory-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }

        .vic-title {
            font-size: 40px;
            color: #fff;
            font-family: serif;
            text-shadow: 0 0 10px red;
            margin-bottom: 30px;
            animation: floatUp 3s ease-out forwards;
        }

        .vic-sub {
            font-size: 100px;
            color: #ffd700;
            font-weight: bold;
            font-family: serif;
            text-shadow: 0 0 30px #d4af37, 2px 2px 0 #000;
            opacity: 0;
            transform: scale(1.5);
            animation: stamp 0.5s 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes stamp {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #080808;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            pointer-events: auto;
        }

        .army-btn {
            margin: 15px;
            padding: 25px 80px;
            font-size: 28px;
            cursor: pointer;
            border: 1px solid #aaa;
            color: white;
            font-family: serif;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .army-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        #btn-east {
            background: linear-gradient(to bottom, #001133, #002255);
            border-color: #88AAEE;
        }

        #btn-west {
            background: linear-gradient(to bottom, #330000, #550000);
            border-color: #EE4444;
        }

        #mist-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)" opacity="0.3"/></svg>');
            opacity: 0.15;
            pointer-events: none;
            z-index: 5;
            mix-blend-mode: screen;
        }

        #formation-panel {
            position: absolute;
            right: 30px;
            top: 100px;
            width: 220px;
            background: rgba(20, 20, 30, 0.95);
            border: 2px solid #888;
            padding: 15px;
            border-radius: 5px;
            pointer-events: auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            display: none;
        }

        .formation-title {
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid #888;
            padding-bottom: 5px;
            color: #ffd700;
            text-align: center;
            letter-spacing: 1px;
        }

        .formation-btn {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid #666;
            background: linear-gradient(to bottom, #333, #222);
            color: #ddd;
            font-family: serif;
            transition: 0.2s;
            position: relative;
        }

        .formation-btn:hover:not(.disabled) {
            background: linear-gradient(to bottom, #444, #333);
            border-color: #ffd700;
            transform: translateX(-3px);
        }

        .formation-btn.active {
            background: linear-gradient(to bottom, #554400, #332200);
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .formation-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: #222;
        }

        #formation-tooltip {
            font-size: 11px;
            color: #aaa;
            margin-top: 10px;
            min-height: 60px;
            line-height: 1.5;
            padding: 5px;
            border-top: 1px solid #444;
        }

        #error-log {
            position: absolute;
            top: 0;
            left: 0;
            color: red;
            font-size: 10px;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body oncontextmenu="return false;">

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="mist-layer"></div>
        <div id="effect-layer"></div>
        <div id="flash-overlay"></div>
        <div id="error-log"></div>

        <div id="ui-layer">
            <div id="top-bar" class="hud-panel">
                <span id="phase-text" style="color:#ffd700">関ヶ原の戦い</span>
                <span id="status-text" style="font-size:14px; color:#ccc; margin-top:4px;">東軍: -- / 西軍: --</span>
            </div>
            <div id="unit-list"></div>
            <button id="action-btn" onclick="commitTurn()">全軍 行動開始</button>
            <div style="position:absolute; bottom:10px; left:10px; font-size:12px; color:#888; font-family:sans-serif;">
                [左ドラッグ] 範囲選択 | [右ドラッグ] マップ移動 | [左クリック] 指示/確認
            </div>
            <div id="context-menu">
                <button class="ctx-btn" style="color:darkred" onclick="issueCommand('ATTACK')">突撃</button>
                <button class="ctx-btn" style="color:darkgreen" onclick="issueCommand('PLOT')">調略</button>
                <button class="ctx-btn" onclick="closeCtx()">取消</button>
            </div>
            <div id="formation-panel" class="hud-panel" style="display:none;">
                <div class="formation-title">陣形選択</div>
                <div id="formation-buttons"></div>
                <div id="formation-tooltip"></div>
            </div>
        </div>

        <div id="start-screen">
            <h1
                style="color:#ddd; font-size:50px; margin-bottom:10px; letter-spacing: 5px; text-shadow: 0 0 10px #fff;">
                関ヶ原の戦い</h1>
            <p style="color:#aaa; font-size:14px; margin-bottom:40px;">調略バランス調整版：戦況により裏切りやすさが変化します</p>
            <div onclick="startGame('EAST')" id="btn-east" class="army-btn">東軍 (徳川家康)</div>
            <div onclick="startGame('WEST')" id="btn-west" class="army-btn">西軍 (石田三成)</div>
        </div>

        <div id="victory-screen">
            <div id="vic-msg-1" class="vic-title"></div>
            <div id="vic-msg-2" class="vic-sub"></div>
            <div id="victory-screen">
                <div id="vic-msg-1" class="vic-title"></div>
                <div id="vic-msg-2" class="vic-sub"></div>
                <div style="margin-top:60px; cursor:pointer; color:#aaa; border-bottom:1px solid #aaa; padding:5px;"
                    onclick="location.reload()">歴史を繰り返す</div>
                100% {
                opacity: 1;
                transform: translateY(0);
                }
                }

                @keyframes stamp {
                to {
                opacity: 1;
                transform: scale(1);
                }
                }

                #start-screen {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #080808;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 200;
                pointer-events: auto;
                }

                .army-btn {
                margin: 15px;
                padding: 25px 80px;
                font-size: 28px;
                cursor: pointer;
                border: 1px solid #aaa;
                color: white;
                font-family: serif;
                position: relative;
                overflow: hidden;
                transition: 0.3s;
                }

                .army-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
                }

                #btn-east {
                background: linear-gradient(to bottom, #001133, #002255);
                border-color: #88AAEE;
                }

                #btn-west {
                background: linear-gradient(to bottom, #330000, #550000);
                border-color: #EE4444;
                }

                #mist-layer {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <filter id="noise">
                        <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch" />
                    </filter>
                    <rect width="100%" height="100%" filter="url(%23noise)" opacity="0.3" />
                </svg>');
                opacity: 0.15;
                pointer-events: none;
                z-index: 5;
                mix-blend-mode: screen;
                }

                #formation-panel {
                position: absolute;
                right: 30px;
                top: 100px;
                width: 220px;
                background: rgba(20, 20, 30, 0.95);
                border: 2px solid #888;
                padding: 15px;
                border-radius: 5px;
                pointer-events: auto;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
                display: none;
                }

                .formation-title {
                font-size: 14px;
                margin-bottom: 10px;
                border-bottom: 1px solid #888;
                padding-bottom: 5px;
                color: #ffd700;
                text-align: center;
                letter-spacing: 1px;
                }

                .formation-btn {
                width: 100%;
                padding: 12px;
                margin: 5px 0;
                font-size: 14px;
                cursor: pointer;
                border: 2px solid #666;
                background: linear-gradient(to bottom, #333, #222);
                color: #ddd;
                font-family: serif;
                transition: 0.2s;
                position: relative;
                }

                .formation-btn:hover:not(.disabled) {
                background: linear-gradient(to bottom, #444, #333);
                border-color: #ffd700;
                transform: translateX(-3px);
                }

                .formation-btn.active {
                background: linear-gradient(to bottom, #554400, #332200);
                border-color: #ffd700;
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                }

                .formation-btn.disabled {
                opacity: 0.3;
                cursor: not-allowed;
                background: #222;
                }

                #formation-tooltip {
                font-size: 11px;
                color: #aaa;
                margin-top: 10px;
                min-height: 60px;
                line-height: 1.5;
                padding: 5px;
                border-top: 1px solid #444;
                }

                #error-log {
                position: absolute;
                top: 0;
                left: 0;
                color: red;
                font-size: 10px;
                pointer-events: none;
                background: rgba(0, 0, 0, 0.5);
                }
                </style>
                </head>

                <body oncontextmenu="return false;">

                    <div id="game-container">
                        <canvas id="gameCanvas"></canvas>
                        <div id="mist-layer"></div>
                        <div id="effect-layer"></div>
                        <div id="flash-overlay"></div>
                        <div id="error-log"></div>

                        <div id="ui-layer">
                            <div id="top-bar" class="hud-panel">
                                <span id="phase-text" style="color:#ffd700">関ヶ原の戦い</span>
                                <span id="status-text" style="font-size:14px; color:#ccc; margin-top:4px;">東軍: -- / 西軍:
                                    --</span>
                            </div>
                            <div id="unit-list"></div>
                            <button id="action-btn" onclick="commitTurn()">全軍 行動開始</button>
                            <div
                                style="position:absolute; bottom:10px; left:10px; font-size:12px; color:#888; font-family:sans-serif;">
                                [左ドラッグ] 範囲選択 | [右ドラッグ] マップ移動 | [左クリック] 指示/確認
                            </div>
                            <div id="context-menu">
                                <button class="ctx-btn" style="color:darkred"
                                    onclick="issueCommand('ATTACK')">突撃</button>
                                <button class="ctx-btn" style="color:darkgreen"
                                    onclick="issueCommand('PLOT')">調略</button>
                                <button class="ctx-btn" onclick="closeCtx()">取消</button>
                            </div>
                            <div id="formation-panel" class="hud-panel" style="display:none;">
                                <div class="formation-title">陣形選択</div>
                                <div id="formation-buttons"></div>
                                <div id="formation-tooltip"></div>
                            </div>
                        </div>

                        <div id="start-screen">
                            <h1
                                style="color:#ddd; font-size:50px; margin-bottom:10px; letter-spacing: 5px; text-shadow: 0 0 10px #fff;">
                                関ヶ原の戦い</h1>
                            <p style="color:#aaa; font-size:14px; margin-bottom:40px;">調略バランス調整版：戦況により裏切りやすさが変化します</p>
                            <div onclick="startGame('EAST')" id="btn-east" class="army-btn">東軍 (徳川家康)</div>
                            <div onclick="startGame('WEST')" id="btn-west" class="army-btn">西軍 (石田三成)</div>
                        </div>

                        <div id="victory-screen">
                            <div id="vic-msg-1" class="vic-title"></div>
                            <div id="vic-msg-2" class="vic-sub"></div>
                            <div id="victory-screen">
                                <div id="vic-msg-1" class="vic-title"></div>
                                <div id="vic-msg-2" class="vic-sub"></div>
                                to {
                                opacity: 1;
                                transform: scale(1);
                                }
                                }

                                #start-screen {
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: #080808;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                z-index: 200;
                                pointer-events: auto;
                                }

                                .army-btn {
                                margin: 15px;
                                padding: 25px 80px;
                                font-size: 28px;
                                cursor: pointer;
                                border: 1px solid #aaa;
                                color: white;
                                font-family: serif;
                                position: relative;
                                overflow: hidden;
                                transition: 0.3s;
                                }

                                .army-btn:hover {
                                transform: scale(1.05);
                                box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
                                }

                                #btn-east {
                                background: linear-gradient(to bottom, #001133, #002255);
                                border-color: #88AAEE;
                                }

                                #btn-west {
                                background: linear-gradient(to bottom, #330000, #550000);
                                border-color: #EE4444;
                                }

                                #mist-layer {
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 200 200"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <filter id="noise">
                                        <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3"
                                            stitchTiles="stitch" />
                                    </filter>
                                    <rect width="100%" height="100%" filter="url(%23noise)" opacity="0.3" />
                                </svg>');
                                opacity: 0.15;
                                pointer-events: none;
                                z-index: 5;
                                mix-blend-mode: screen;
                                }

                                #formation-panel {
                                position: absolute;
                                right: 30px;
                                top: 100px;
                                width: 220px;
                                background: rgba(20, 20, 30, 0.95);
                                border: 2px solid #888;
                                padding: 15px;
                                border-radius: 5px;
                                pointer-events: auto;
                                box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
                                display: none;
                                }

                                .formation-title {
                                font-size: 14px;
                                margin-bottom: 10px;
                                border-bottom: 1px solid #888;
                                padding-bottom: 5px;
                                color: #ffd700;
                                text-align: center;
                                letter-spacing: 1px;
                                }

                                .formation-btn {
                                width: 100%;
                                padding: 12px;
                                margin: 5px 0;
                                font-size: 14px;
                                cursor: pointer;
                                border: 2px solid #666;
                                background: linear-gradient(to bottom, #333, #222);
                                color: #ddd;
                                font-family: serif;
                                transition: 0.2s;
                                position: relative;
                                }

                                .formation-btn:hover:not(.disabled) {
                                background: linear-gradient(to bottom, #444, #333);
                                border-color: #ffd700;
                                transform: translateX(-3px);
                                }

                                .formation-btn.active {
                                background: linear-gradient(to bottom, #554400, #332200);
                                border-color: #ffd700;
                                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                                }

                                .formation-btn.disabled {
                                opacity: 0.3;
                                cursor: not-allowed;
                                background: #222;
                                }

                                #formation-tooltip {
                                font-size: 11px;
                                color: #aaa;
                                margin-top: 10px;
                                min-height: 60px;
                                line-height: 1.5;
                                padding: 5px;
                                border-top: 1px solid #444;
                                }

                                #error-log {
                                position: absolute;
                                top: 0;
                                left: 0;
                                color: red;
                                font-size: 10px;
                                pointer-events: none;
                                background: rgba(0, 0, 0, 0.5);
                                }
                                </style>
                                </head>

                                <body oncontextmenu="return false;">

                                    <div id="game-container">
                                        <canvas id="gameCanvas"></canvas>
                                        <div id="mist-layer"></div>
                                        <div id="effect-layer"></div>
                                        <div id="flash-overlay"></div>
                                        <div id="error-log"></div>

                                        <div id="ui-layer">
                                            <div id="top-bar" class="hud-panel">
                                                <span id="phase-text" style="color:#ffd700">関ヶ原の戦い</span>
                                                <span id="status-text"
                                                    style="font-size:14px; color:#ccc; margin-top:4px;">東軍: -- / 西軍:
                                                    --</span>
                                            </div>
                                            <div id="unit-list"></div>
                                            <button id="action-btn" onclick="commitTurn()">全軍 行動開始</button>
                                            <div
                                                style="position:absolute; bottom:10px; left:10px; font-size:12px; color:#888; font-family:sans-serif;">
                                                [左ドラッグ] 範囲選択 | [右ドラッグ] マップ移動 | [左クリック] 指示/確認
                                            </div>
                                            <div id="context-menu">
                                                <button class="ctx-btn" style="color:darkred"
                                                    onclick="issueCommand('ATTACK')">突撃</button>
                                                <button class="ctx-btn" style="color:darkgreen"
                                                    onclick="issueCommand('PLOT')">調略</button>
                                                <button class="ctx-btn" onclick="closeCtx()">取消</button>
                                            </div>
                                            <div id="formation-panel" class="hud-panel" style="display:none;">
                                                <div class="formation-title">陣形選択</div>
                                                <div id="formation-buttons"></div>
                                                <div id="formation-tooltip"></div>
                                            </div>
                                        </div>

                                        <div id="start-screen">
                                            <h1
                                                style="color:#ddd; font-size:50px; margin-bottom:10px; letter-spacing: 5px; text-shadow: 0 0 10px #fff;">
                                                関ヶ原の戦い</h1>
                                            <p style="color:#aaa; font-size:14px; margin-bottom:40px;">
                                                調略バランス調整版：戦況により裏切りやすさが変化します</p>
                                            <div onclick="startGame('EAST')" id="btn-east" class="army-btn">東軍 (徳川家康)
                                            </div>
                                            <div onclick="startGame('WEST')" id="btn-west" class="army-btn">西軍 (石田三成)
                                            </div>
                                        </div>

                                        <div id="victory-screen">
                                            <div id="vic-msg-1" class="vic-title"></div>
                                            <div id="vic-msg-2" class="vic-sub"></div>
                                            <div id="victory-screen">
                                                <div id="vic-msg-1" class="vic-title"></div>
                                                <div id="vic-msg-2" class="vic-sub"></div>
                                                #start-screen {
                                                position: absolute;
                                                top: 0;
                                                left: 0;
                                                width: 100%;
                                                height: 100%;
                                                background: #080808;
                                                display: flex;
                                                flex-direction: column;
                                                align-items: center;
                                                justify-content: center;
                                                z-index: 200;
                                                pointer-events: auto;
                                                }

                                                .army-btn {
                                                margin: 15px;
                                                padding: 25px 80px;
                                                font-size: 28px;
                                                cursor: pointer;
                                                border: 1px solid #aaa;
                                                color: white;
                                                font-family: serif;
                                                position: relative;
                                                overflow: hidden;
                                                transition: 0.3s;
                                                }

                                                .army-btn:hover {
                                                transform: scale(1.05);
                                                box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
                                                }

                                                #btn-east {
                                                background: linear-gradient(to bottom, #001133, #002255);
                                                border-color: #88AAEE;
                                                }

                                                #btn-west {
                                                background: linear-gradient(to bottom, #330000, #550000);
                                                border-color: #EE4444;
                                                }

                                                #mist-layer {
                                                position: absolute;
                                                top: 0;
                                                left: 0;
                                                width: 100%;
                                                height: 100%;
                                                background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 200 200"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <filter id="noise">
                                                        <feTurbulence type="fractalNoise" baseFrequency="0.65"
                                                            numOctaves="3" stitchTiles="stitch" />
                                                    </filter>
                                                    <rect width="100%" height="100%" filter="url(%23noise)"
                                                        opacity="0.3" />
                                                </svg>');
                                                opacity: 0.15;
                                                pointer-events: none;
                                                z-index: 5;
                                                mix-blend-mode: screen;
                                                }

                                                #formation-panel {
                                                position: absolute;
                                                right: 30px;
                                                top: 100px;
                                                width: 220px;
                                                background: rgba(20, 20, 30, 0.95);
                                                border: 2px solid #888;
                                                padding: 15px;
                                                border-radius: 5px;
                                                pointer-events: auto;
                                                box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
                                                display: none;
                                                }

                                                .formation-title {
                                                font-size: 14px;
                                                margin-bottom: 10px;
                                                border-bottom: 1px solid #888;
                                                padding-bottom: 5px;
                                                color: #ffd700;
                                                text-align: center;
                                                letter-spacing: 1px;
                                                }

                                                .formation-btn {
                                                width: 100%;
                                                padding: 12px;
                                                margin: 5px 0;
                                                font-size: 14px;
                                                cursor: pointer;
                                                border: 2px solid #666;
                                                background: linear-gradient(to bottom, #333, #222);
                                                color: #ddd;
                                                font-family: serif;
                                                transition: 0.2s;
                                                position: relative;
                                                }

                                                .formation-btn:hover:not(.disabled) {
                                                background: linear-gradient(to bottom, #444, #333);
                                                border-color: #ffd700;
                                                transform: translateX(-3px);
                                                }

                                                .formation-btn.active {
                                                background: linear-gradient(to bottom, #554400, #332200);
                                                border-color: #ffd700;
                                                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                                                }

                                                .formation-btn.disabled {
                                                opacity: 0.3;
                                                cursor: not-allowed;
                                                background: #222;
                                                }

                                                #formation-tooltip {
                                                font-size: 11px;
                                                color: #aaa;
                                                margin-top: 10px;
                                                min-height: 60px;
                                                line-height: 1.5;
                                                padding: 5px;
                                                border-top: 1px solid #444;
                                                }

                                                #error-log {
                                                position: absolute;
                                                top: 0;
                                                left: 0;
                                                color: red;
                                                font-size: 10px;
                                                pointer-events: none;
                                                background: rgba(0, 0, 0, 0.5);
                                                }
                                                </style>
                                                </head>

                                                <body oncontextmenu="return false;">

                                                    <div id="game-container">
                                                        <canvas id="gameCanvas"></canvas>
                                                        <div id="mist-layer"></div>
                                                        <div id="effect-layer"></div>
                                                        <div id="flash-overlay"></div>
                                                        <div id="error-log"></div>

                                                        <div id="ui-layer">
                                                            <div id="top-bar" class="hud-panel">
                                                                <span id="phase-text"
                                                                    style="color:#ffd700">関ヶ原の戦い</span>
                                                                <span id="status-text"
                                                                    style="font-size:14px; color:#ccc; margin-top:4px;">東軍:
                                                                    -- / 西軍:
                                                                    --</span>
                                                            </div>
                                                            <div id="unit-list"></div>
                                                            <button id="action-btn" onclick="commitTurn()">全軍
                                                                行動開始</button>
                                                            <div
                                                                style="position:absolute; bottom:10px; left:10px; font-size:12px; color:#888; font-family:sans-serif;">
                                                                [左ドラッグ] 範囲選択 | [右ドラッグ] マップ移動 | [左クリック] 指示/確認
                                                            </div>
                                                            <div id="context-menu">
                                                                <button class="ctx-btn" style="color:darkred"
                                                                    onclick="issueCommand('ATTACK')">突撃</button>
                                                                <button class="ctx-btn" style="color:darkgreen"
                                                                    onclick="issueCommand('PLOT')">調略</button>
                                                                <button class="ctx-btn" onclick="closeCtx()">取消</button>
                                                            </div>
                                                            <div id="formation-panel" class="hud-panel"
                                                                style="display:none;">
                                                                <div class="formation-title">陣形選択</div>
                                                                <div id="formation-buttons"></div>
                                                                <div id="formation-tooltip"></div>
                                                            </div>
                                                        </div>

                                                        <div id="start-screen">
                                                            <h1
                                                                style="color:#ddd; font-size:50px; margin-bottom:10px; letter-spacing: 5px; text-shadow: 0 0 10px #fff;">
                                                                関ヶ原の戦い</h1>
                                                            <p style="color:#aaa; font-size:14px; margin-bottom:40px;">
                                                                調略バランス調整版：戦況により裏切りやすさが変化します</p>
                                                            <div onclick="startGame('EAST')" id="btn-east"
                                                                class="army-btn">東軍 (徳川家康)
                                                            </div>
                                                            <div onclick="startGame('WEST')" id="btn-west"
                                                                class="army-btn">西軍 (石田三成)
                                                            </div>
                                                        </div>

                                                        <div id="victory-screen">
                                                            <div id="vic-msg-1" class="vic-title"></div>
                                                            <div id="vic-msg-2" class="vic-sub"></div>
                                                            <div id="victory-screen">
                                                                <div id="vic-msg-1" class="vic-title"></div>
                                                                <div id="vic-msg-2" class="vic-sub"></div>
                                                                <div style="margin-top:60px; cursor:pointer; color:#aaa; border-bottom:1px solid #aaa; padding:5px;"
                                                                    onclick="location.reload()">歴史を繰り返す</div>
                                                            </div>
                                                        </div>

                                                        <script>
                                                            // エラーログ表示機能
                                                            window.onerror = function (message, source, lineno, colno, error) {
                                                                const log = document.getElementById('error-log');
                                                                if (log) {
                                                                    log.style.display = 'block';
                                                                    log.style.color = 'red';
                                                                    log.style.zIndex = '9999';
                                                                    log.innerHTML += `<div style="background:rgba(0,0,0,0.8); padding:5px; margin:2px; border:1px solid red;">Error: ${message} <br>at ${source}:${lineno}</div>`;
                                                                }
                                                            };
                                                        </script>

                                                        <script type="module">
                                                            import { Game } from './scripts/main.js?v=21';

                                                            try {
                                                                // グローバルスコープにGameインスタンスを作成
                                                                window.game = new Game();

                                                                // ページ読み込み完了時に初期化
                                                                window.onload = () => {
                                                                    try {
                                                                        window.game.init();
                                                                    } catch (e) {
                                                                        console.error("Init failed", e);
                                                                        throw e;
                                                                    }
                                                                };

                                                                window.startGame = (side) => {
                                                                    try {
                                                                        window.game.startGame(side);
                                                                    } catch (e) {
                                                                        console.error("StartGame failed", e);
                                                                        throw e;
                                                                    }
                                                                };

                                                                window.issueCommand = (type) => {
                                                                    try {
                                                                        window.game.issueCommand(type);
                                                                    } catch (e) {
                                                                        console.error("IssueCommand failed", e);
                                                                        throw e;
                                                                    }
                                                                };

                                                                window.commitTurn = () => {
                                                                    try {
                                                                        window.game.commitTurn();
                                                                    } catch (e) {
                                                                        console.error("CommitTurn failed", e);
                                                                        throw e;
                                                                    }
                                                                };

                                                                window.closeCtx = () => window.game.closeCtx();

                                                            } catch (e) {
                                                                console.error("Module setup failed", e);
                                                                throw e;
                                                            }
                                                        </script>


                                                </body>

</html>