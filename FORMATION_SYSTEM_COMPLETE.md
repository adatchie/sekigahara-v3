# 陣形システム実装完了レポート

## 実装概要
CPU側の本陣ユニットが先陣を切って突出する問題を解決するため、陣形システムを実装しました。
各武将は目標設定フェイズに陣形（鋒矢・鶴翼・魚鱗）を選択でき、陣形に応じて移動制限とステータス修正が適用されます。

---

## 実装完了項目

### ✅ Phase 1: データ構造とUI
1. **constants.js** - 陣形定数を追加
   - `FORMATION_HOKO` (鋒矢の陣)
   - `FORMATION_KAKUYOKU` (鶴翼の陣)
   - `FORMATION_GYORIN` (魚鱗の陣)

2. **unit-manager.js** - `formation`フィールドを追加
   - ユニットデータに陣形情報を保存

3. **sekigahara.html** - 陣形選択パネルのUI追加
   - CSS: 陣形ボタン、ツールチップ、activeクラス
   - HTML: formation-panel要素

4. **formation.js (新規)** - 陣形ロジック
   - `FORMATION_INFO`: 各陣形の詳細情報（名前、説明、ステータス修正、配下要件）
   - `getFormationModifiers()`: 陣形によるステータス修正を取得
   - `canMoveWithFormation()`: 陣形要件を満たすか判定
   - `getAvailableFormations()`: 選択可能な陣形を取得
   - `checkForcedFormationChange()`: 兵力による強制陣形変更チェック

5. **combat.js** - 陣形名表示メソッド
   - `showFormation()`: FLOAT_TEXTエフェクトで陣形名を表示

### ✅ Phase 2: 陣形ロジックとUI統合
6. **main.js** - UI表示ロジック
   - `showFormationPanel()`: 本陣選択時に陣形パネルを表示
   - `hideFormationPanel()`: パネルを非表示
   - `setFormation()`: 陣形を設定し、表示エフェクトを発動
   - 本陣クリック時の陣形パネル表示処理
   - 陣形インポート追加

7. **combat.js** - ステータス修正の適用
   - インポート追加: `getFormationModifiers, canMoveWithFormation, checkForcedFormationChange, FORMATION_INFO`
   - 戦闘時のダメージ計算に陣形修正を適用
   - `constructor`に`unitManager`パラメータ追加
   - `setUnitManager()`メソッド追加

8. **combat.js** - 移動制限と強制陣形変更
   - `processUnit()`: 本陣兵力による強制陣形変更をチェック
   - `processMove()`: 陣形要件を満たさない場合、自動で陣形を緩和
     - 魚鱗 → 鶴翼 → 鋒矢の順に変更
     - それでも移動できない場合は移動をキャンセル

9. **main.js** - unitManager連携
   - `startGame()`でcombatSystemにunitManagerを設定

### ✅ Phase 3: CPU AI
10. **ai.js** - 陣形判定ロジック
    - インポート追加: 陣形定数、`UNIT_TYPE_HEADQUARTERS`
    - `decideFormation()`: CPU陣形を決定
      - 本陣兵力500以下→魚鱗、800以下→鶴翼を強制
      - 配下ユニット数による制限
      - 周囲5HEX以内の兵力比率で判定
        - 1.5倍以上→鋒矢（優勢）
        - 0.67倍以下→魚鱗（劣勢）
        - その間→鶴翼（拮抗）
    - `countNearbyForces()`: 周囲の兵力を計算

11. **main.js** - CPU陣形自動選択
   - `commitTurn()`でCPU本陣の陣形を自動決定
   - ターン開始時にAIが戦術状況を評価して陣形を選択

---

## 機能詳細

### 陣形の種類と効果
| 陣形 | 攻撃修正 | 防御修正 | 前方配下要件 | 特徴 |
|------|----------|----------|--------------|------|
| 鋒矢 | +20 | -20 | 0以上 | 攻撃的・本陣前方 |
| 鶴翼 | ±0 | ±0 | 1以上 | バランス型・本陣中央 |
| 魚鱗 | -20 | +20 | 2以上 | 防御的・本陣後方 |

### UI/UX
1. **本陣選択時**
   - 陣形選択パネルが表示される
   - 3つの陣形ボタン（鋒矢・鶴翼・魚鱗）
   - マウスオーバーで説明を表示
   - 現在の陣形は金色でハイライト
   - 選択不可の陣形はグレーアウト

2. **陣形設定/変更時**
   - 【陣形名】がFLOAT_TEXTエフェクトで表示
   - ダメージ表示と同じ要領で視覚的にフィードバック

3. **自動変更時**
   - 兵力低下や移動制限による強制変更時も陣形名を表示
   - コンソールに変更ログを出力

### 移動制限
- 本陣が目標に向かう経路とその左右のHEXに配下ユニットがいるかチェック
- 要件を満たさない場合：
  1. 自動的に陣形を緩和（魚鱗→鶴翼→鋒矢）
  2. 緩和後も移動できなければ移動をキャンセル
  3. 変更時に陣形名を表示

### 強制陣形変更
- **本陣兵力500以下**: 魚鱗に強制変更
- **本陣兵力800以下**: 鶴翼に強制変更（魚鱗からの変更は除く）
- 変更時に陣形名を表示

### CPU AI戦術
- ターン開始時に戦術状況を評価
- 周囲5HEX以内の敵味方兵力比率で判定
- 兵力低下時は自動的に防御的な陣形へ
- 優勢時は攻撃的な陣形を選択

---

## テスト項目チェックリスト

### 基本機能
- ✅ 本陣選択時に陣形パネルが表示される
- ✅ 配下ユニット数に応じて選択不可陣形がグレーアウトされる
- ✅ 陣形選択時にステータスが修正される（攻撃±20、防御±20）
- ✅ 陣形選択時に【陣形名】が表示される
- ✅ CPU AIが状況に応じて適切な陣形を選択する

### 移動制限（今後テスト予定）
- [ ] 陣形要件を満たさない場合、本陣が自動で陣形を変更する
- [ ] 陣形変更時に【陣形名】が表示される
- [ ] 変更後も移動できない場合は移動がキャンセルされる

### 強制変更（今後テスト予定）
- [ ] 本陣兵力800以下で鶴翼に変更される
- [ ] 本陣兵力500以下で魚鱗に変更される
- [ ] 変更時に【陣形名】が表示される

---

## 技術的詳細

### ファイル構成
```
sekigahara4/
├── scripts/
│   ├── constants.js        (陣形定数定義)
│   ├── formation.js        (陣形ロジック) ★新規
│   ├── unit-manager.js     (formationフィールド追加)
│   ├── combat.js           (ステータス修正、移動制限、強制変更)
│   ├── main.js             (UI制御、陣形パネル表示)
│   └── ai.js               (CPU陣形決定ロジック)
└── sekigahara.html         (陣形パネルUI)
```

### HEX座標系
- **形状**: Pointy-top hexagon
- **左右判定**: 進行方向のインデックス±1で計算
- **経路計算**: `getLine()`で直線補間

### エフェクトシステム統合
- `FLOAT_TEXT`エフェクトを再利用
- `showFormation()`で統一的に陣形名を表示
- 金色(#ffd700)で表示、寿命80フレーム

---

## 今後の拡張案

### 中期計画
1. **陣形の視覚的表現**
   - 配下ユニットの配置が陣形に応じて変わる
   - 本陣周りに陣形アイコンを表示

2. **より多様な陣形**
   - 長槍の陣、車懸りの陣など
   - 武将の特性に応じた専用陣形

3. **陣形の練度システム**
   - 同じ陣形を使い続けると効果アップ
   - 実戦経験による熟練度

### 長期計画
4. **陣形破り**
   - 特定の陣形に有利不利
   - 三すくみの関係性

5. **天候・時間の影響**
   - 雨天時は鋒矢が不利など
   - 夜戦での陣形効果変化

---

## パフォーマンス考慮

### 最適化ポイント
- 移動判定は本陣ユニットのみ
- 経路計算はgetLine()で軽量化
- CPU陣形決定は半径5HEXに限定

### 将来的な改善余地
- 経路上の配下チェックをキャッシュ
- LOD実装（距離に応じた詳細度調整）

---

## 実装完了日
2025-12-06

## 実装者コメント
陣形システムの完全統合が完了しました。
プレイヤーは本陣選択時に陣形パネルから3種類の陣形を選択でき、陣形に応じてステータス修正と移動制限が適用されます。
CPU AIも戦術状況を評価して自動的に最適な陣形を選択します。
本陣の兵力が低下した場合や、配下ユニットが足りない場合は自動的に陣形が変更されるため、本陣が無謀に突出することを防ぎます。
